#!/bin/ksh

# digital_rain.sh - A tiny matrix digital rain script in ksh.

# Author: Hajime Edakawa <hajime.edakawa@gmail.com>
# License: Public Domain
# Last Update: Dec, 2018

# Require (for display Japanese font):
#    pkg_add mixfont-mplus-ipa-20060520p7.tgz

# Comment:
#     This script was tested on OpenBSD 6.4 only.

#-------------------------------------------------------------------------------
typeset -r WHITE=15 \
           BLACK=0
           YELLOW=11
           GREEN3=34
	   DARKGREEN=22
           GREEN4=28

set -A BRD \
    -A _CPAT ${YELLOW} ${GREEN3} ${GREEN3} ${GREEN3} ${DARKGREEN} ${DARKGREEN} \
             ${DARKGREEN} ${GREEN4} ${BLACK} ${BLACK}
 
typeset T=" TINY DIGITAL RAIN " \
        W=60                    \
        H=15

typeset HL="\033(0q\033(B" \
        VL="\033(0x\033(B" \
        TL="\033(0l\033(B" \
        TR="\033(0k\033(B" \
        BL="\033(0m\033(B" \
        BR="\033(0j\033(B"

set -A sutra "\0350\0210\0254" "\0350\0213\0245" "\0345\0277\0203" \
             "\0347\0265\0214" "\0346\0221\0251" "\0350\0250\0266" \
             "\0346\0263\0242" "\0347\0276\0205" "\0345\0257\0206" \
             "\0345\0244\0232" "\0350\0246\0263" "\0350\0207\0252" \
             "\0345\0234\0250" "\0350\0217\0251" "\0350\0226\0251" \
             "\0350\0241\0214" "\0346\0267\0261" "\0346\0231\0202" \
             "\0347\0205\0247" "\0350\0246\0213" "\0344\0272\0224" \
             "\0350\0230\0212" "\0347\0232\0206" "\0347\0251\0272" \
             "\0345\0272\0246" "\0344\0270\0200" "\0345\0210\0207" \
             "\0350\0213\0246" "\0345\0216\0204" "\0350\0210\0216" \
             "\0345\0210\0251" "\0345\0255\0220" "\0350\0211\0262" \
             "\0344\0270\0215" "\0347\0225\0260" "\0345\0215\0263" \
             "\0346\0230\0257" "\0345\0217\0227" "\0346\0203\0263" \
             "\0350\0255\0230" "\0344\0272\0246" "\0345\0276\0251" \
             "\0345\0246\0202" "\0350\0253\0270" "\0346\0263\0225" \
             "\0347\0233\0270" "\0347\0224\0237" "\0346\0273\0205" \
             "\0345\0236\0242" "\0346\0265\0204" "\0345\0242\0227" \
             "\0346\0270\0233" "\0346\0225\0205" "\0344\0270\0255" \
             "\0347\0204\0241" "\0347\0234\0274" "\0350\0200\0263" \
             "\0351\0274\0273" "\0350\0210\0214" "\0350\0272\0253" \
             "\0346\0204\0217" "\0345\0243\0260" "\0351\0246\0231" \
             "\0345\0221\0263" "\0350\0247\0246" "\0347\0225\0214" \
             "\0344\0271\0203" "\0350\0207\0263" "\0346\0230\0216" \
             "\0345\0260\0275" "\0350\0200\0201" "\0346\0255\0273" \
             "\0351\0233\0206" "\0351\0201\0223" "\0346\0231\0272" \
             "\0345\0276\0227" "\0344\0273\0245" "\0346\0211\0200" \
             "\0346\0217\0220" "\0345\0236\0202" "\0344\0276\0235" \
             "\0350\0234\0234" "\0345\0234\0255" "\0347\0244\0231" \
             "\0346\0234\0211" "\0346\0201\0220" "\0346\0200\0226" \
             "\0351\0201\0240" "\0351\0233\0242" "\0351\0241\0233" \
             "\0345\0200\0222" "\0345\0244\0242" "\0347\0251\0266" \
             "\0347\0253\0237" "\0346\0266\0205" "\0346\0247\0203" \
             "\0344\0270\0211" "\0344\0270\0226" "\0344\0273\0217" \
             "\0351\0230\0277" "\0350\0200\0250" "\0350\0227\0220" \
             "\0347\0237\0245" "\0345\0244\0247" "\0347\0245\0236" \
             "\0345\0221\0252" "\0344\0270\0212" "\0347\0255\0211" \
             "\0350\0203\0275" "\0351\0231\0244" "\0347\0234\0237" \
             "\0345\0256\0237" "\0350\0231\0232" "\0350\0252\0254" \
             "\0346\0233\0260" "\0347\0276\0257" "\0350\0253\0246" \
             "\0345\0203\0247" "\0345\0251\0206"
#-------------------------------------------------------------------------------
function restore {
        tput cnorm
	reset_fcolor
	reset_bcolor
	tput cup $H 0
	exit
}

function set_fcolor {
        local n=${1:-0}
        (( 0 <= n && n <= 255 )) && print -n "\033[38;5;${n}m"
}

function reset_fcolor {
        print -n "\033[39m"
}

function set_bcolor {
        local n=${1:-0}
        (( 0 <= n && n <= 255 )) && print -n "\033[48;5;${n}m"
}

function reset_bcolor {
        print -n "\033[49m"
}

function draw_with_box {
	set -A rot
	local i j x y t inside
	local rnd=$1
	local flg=$2

	(( W % 2 == 1 )) && let W--
	(( H % 2 == 1 )) && let H--

	if [[ -z ${BRD} ]]; then
		for y in $(jot $(( H-2 )) 0); do
			t[y]=${BLACK}
		done
		for x in $(jot $(( (W-2)/2 )) 0); do
			BRD[x]="$(echo ${t[*]} | sed 's/ /:/g')"
		done
	fi	

	for y in $(jot $(( H-2 )) 0); do
		for x in $(jot $(( (W-2)/2 )) 0); do
			t=${BRD[x]##*:}
			[[ -z "${rot[y]}" ]] && rot[y]=${t} || \
                            rot[y]="${rot[y]}:${t}"
		        BRD[x]="${BRD[x]##*:}:${BRD[x]%:*}"
		done
	done

	for y in $(jot ${H} 0); do
		tput cup ${y} 0
		x=0
		while (( x < W )); do
			t=${VL}
			inside=0
			if (( 0 < x && x < W-1 )); then
				if (( y == 0 && x == 1 )); then
					t=${T}
					let x+=${#T}-1
				elif (( y == 0 || y == H-1 )); then
					t=${HL}
				else
					inside=1
				fi
			elif (( x ==   0 && y ==   0 )); then t=${TL}
			elif (( x ==   0 && y == H-1 )); then t=${BL}
			elif (( x == W-1 && y ==   0 )); then t=${TR}
			elif (( x == W-1 && y == H-1 )); then t=${BR}
			fi
			if (( inside == 1 )); then
				t=${sutra[RANDOM%${#sutra}]}
	                        set_fcolor "${rot[y-1]%%:*}"
				set_bcolor "${BLACK}"
				print -n "${t}"
				reset_fcolor
 				rot[y-1]=${rot[y-1]#*:}
				let x++
			else
				print -n "${t}"
			fi
			let x++
		done
	done

	for x in $(jot $(( (W-2)/2  )) 0); do
		if (( x == rnd )); then
			if (( flg == 1 )); then
				BRD[x]="${BRD[x]#*:}:${WHITE}"
			else
				BRD[x]="${BRD[x]#*:}:${BLACK}"
			fi
		else
			BRD[x]="${BRD[x]#*:}:${_CPAT[ RANDOM%${#_CPAT[*]} ]}"
		fi
	done
}

function main {
	integer gap=$H
	integer rnd=$(( RANDOM%((W-2)/2) ))
	tput clear
	tput civis
	for i in $(jot 100); do
		if (( gap == H )); then
			draw_with_box "${rnd}" 1
			let gap-=2
		else
			draw_with_box "${rnd}" 0
		fi
		let gap--
		if (( gap <= 0 )); then
			gap=$H
			rnd=$(( RANDOM%((W-2)/2) ))
		fi
		sleep 0.016
	done
}
#-------------------------------------------------------------------------------
trap restore EXIT INT

main
#-------------------------------------------------------------------------------
